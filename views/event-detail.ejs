<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <title>
        <%= event.name %>
    </title>
    <link rel="stylesheet" href="/style.css">
</head>

<body>
    <%- include('partials/header') %>

        <h1>
            <%= event.name %>
        </h1>
        <div
            style="margin: auto; max-width: 500px; background-color: #333; padding: 20px; border-radius: 10px; color: white;">
            <img src="<%= event.image %>" alt="<%= event.name %>" style="width:100%; height: auto; border-radius:5px;">
            <p><strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong>
                <%= event.description %>
            </p>
            <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong>
                <%= new Date(event.date).toLocaleDateString() %>
            </p>
            <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</strong>
                <%= event.location %>
            </p>
        </div>
        
        <% if (!currentUser || currentUser.role==='Attendee' ) { %>
            <form id="bookingForm" action="/events/<%= event._id %>/book" method="POST" style="margin-top:20px;">
                <label for="zone"><strong>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô:</strong></label>
                <select name="zone" id="zone" required>
                    <% event.zones.forEach(zone=> {
                        const remaining = zone.seats - (zone.bookedSeats?.length || 0);
                        %>
                        <option value="<%= zone.name %>" data-price="<%= zone.price %>" data-max="<%= remaining %>">
                            ‡πÇ‡∏ã‡∏ô <%= zone.name %> (‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <%= remaining %>)
                        </option>
                        <% }) %>
                </select>

                <label for="quantity">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á:</label>
                <input type="number" name="quantity" id="quantity" min="1" max="4" required>
                <small>‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î4</small>

                <button type="button" class="btn" id="confirmBtn">‡∏ã‡∏∑‡πâ‡∏≠‡∏ö‡∏±‡∏ï‡∏£</button>
            </form>

            <!-- Modal -->
            <div id="confirmModal" style="
    display:none;
    position:fixed;
    top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.5);
    justify-content:center; align-items:center;
">
                <div
                    style="background:white; padding:20px; border-radius:10px; max-width:400px; width:90%; text-align:center;">
                    <h3>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3>
                    <p id="modalText"></p>
                    <div style="display: flex; justify-content: end;">
                        <button id="modalConfirm" class="btn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                        <button id="modalCancel" class="btn" style="background:#ccc;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>

                </div>
            </div>

            <script>
                const zoneSelect = document.getElementById('zone');
                const quantityInput = document.getElementById('quantity');
                const confirmBtn = document.getElementById('confirmBtn');
                const modal = document.getElementById('confirmModal');
                const modalText = document.getElementById('modalText');
                const modalConfirm = document.getElementById('modalConfirm');
                const modalCancel = document.getElementById('modalCancel');
                const bookingForm = document.getElementById('bookingForm');

                function updateMax() {
                    const selectedOption = zoneSelect.selectedOptions[0];
                    quantityInput.max = selectedOption.dataset.max;
                    if (quantityInput.value > quantityInput.max);
                }

                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
                updateMax();
                zoneSelect.addEventListener('change', updateMax);

                // ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ã‡∏∑‡πâ‡∏≠ ‚Üí ‡πÅ‡∏™‡∏î‡∏á modal
                confirmBtn.addEventListener('click', () => {
    const zone = zoneSelect.value;
    let quantity = parseInt(quantityInput.value);
    const remaining = parseInt(zoneSelect.selectedOptions[0].dataset.max);
    const price = parseInt(zoneSelect.selectedOptions[0].dataset.price);
    const total = quantity * price;

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á
    if (!quantity || quantity <= 0) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏∞ ü™ë");
        quantityInput.focus();
        return;
    }

    if (quantity > remaining) {
        alert(`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠! ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ${remaining} ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á`);
        quantityInput.value = remaining;
        return;
    }

    if (quantity > 4) {
        alert(`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ñ‡∏∑‡∏≠ 4`);
        quantityInput.value = 4;
        return;
    }

    modalText.innerHTML = `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á <strong>${quantity}</strong> ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡πÉ‡∏ô‡πÇ‡∏ã‡∏ô <strong>${zone}</strong><br>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°: <strong>${total}</strong> ‡∏ö‡∏≤‡∏ó?`;
    modal.style.display = 'flex';
});

                // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ô modal ‚Üí ‡∏™‡πà‡∏á form
                modalConfirm.addEventListener('click', () => {
                    bookingForm.submit();
                });

                // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ô modal ‚Üí ‡∏õ‡∏¥‡∏î modal
                modalCancel.addEventListener('click', () => {
                    modal.style.display = 'none';
                });

                // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å modal ‚Üí ‡∏õ‡∏¥‡∏î modal
                window.addEventListener('click', (e) => {
                    if (e.target === modal) modal.style.display = 'none';
                });
            </script>
            <% } %>

                <%- include('partials/footer') %>
</body>

</html>